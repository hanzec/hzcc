stages:
  - build
  - test
  - documentation

variables:
  CMAKE_VERSION: "3.16.0"

.install_vcpkg_dep: &install_vcpkg_dep
  before_script:
    - apt-get -qq update
    - apt-get -qq install -y curl zip unzip tar pkg-config cmake # install vcpkg dependencies

.install_latex_dep: &install_latex_dep
  before_script:
    - apt-get -qq update
    - apt-get -qq install -y texlive-base texlive-latex-recommended texlive-latex-extra

.install_ninja_build: &install_ninja_build
  before_script:
    - apt-get -qq update
    - apt-get -qq install -y ninja-build

.install_cmake_3_16_0: &install_cmake_3_16_0
  before_script:
    - apt-get -qq update
    - apt-get -qq install -y git wget
    - mkdir -p /tmp && cd /tmp
    - wget -q "https://github.com/Kitware/CMake/releases/download/v$CMAKE_VERSION/cmake-$CMAKE_VERSION-linux-x86_64.sh" -P /tmp
    - chmod +x /tmp/cmake-$CMAKE_VERSION-linux-x86_64.sh
    - /tmp/cmake-$CMAKE_VERSION-linux-x86_64.sh --skip-license --prefix=/usr/local

.testing_default: &testing_default
  before_script:
    - !reference [ .install_vcpkg_dep, before_script ]
    - !reference [ .install_ninja_build, before_script ]
    - !reference [ .install_cmake_3_16_0, before_script ]

.compile_default: &compile_default
  before_script:
    - !reference [ .install_vcpkg_dep, before_script ]
    - !reference [ .install_cmake_3_16_0, before_script ]

.documentation_default: &documentation_default
  before_script:
    - !reference [ .install_vcpkg_dep, before_script ]
    - !reference [ .install_latex_dep, before_script ]
    - !reference [ .install_ninja_build, before_script ]
    - !reference [ .install_cmake_3_16_0, before_script ]

build_gcc_10_3_ninja_debug:
  <<: *compile_default
  stage: build
  image: gcc:10.3
  tags:
    - docker
  script:
    - apt-get -qq update
    - cd $CI_PROJECT_DIR
    - apt-get -qq install -y ninja-build # install ninja
    - cmake . -B./build/ -DCMAKE_BUILD_TYPE=Release -G Ninja && cd ./build && ninja -j$(nproc) mycc
  cache:
    - key: "gcc_10_3_ninja_$CI_COMMIT_SHORT_SHA($CI_RUNNER_ID)"
      paths:
        - "$CI_PROJECT_DIR/build"

test_gcc_10_3_debug:
  <<: *testing_default
  image: gcc:10.3
  stage: test
  tags:
    - docker
  script:
    - cd $CI_PROJECT_DIR
    - cmake . -B./build/ -DCMAKE_BUILD_TYPE=Debug -G Ninja && cd ./build && ninja -j$(nproc) mycc_test
    - cd $CI_PROJECT_DIR/build/bin && ./mycc_test --gtest_output="xml:$CI_PROJECT_DIR/gtest_report.xml"
  artifacts:
    when: always
    reports:
      junit: $CI_PROJECT_DIR/gtest_report.xml
  needs:
    - build_gcc_10_3_ninja_debug
  cache:
    - key: "gcc_10_3_ninja_$CI_COMMIT_SHORT_SHA($CI_RUNNER_ID)"
      paths:
        - "$CI_PROJECT_DIR/build"

test_gcc_10_3_release:
  <<: *testing_default
  image: gcc:10.3
  stage: test
  tags:
    - docker
  script:
    - cd $CI_PROJECT_DIR
    - cmake . -B./build/ -DCMAKE_BUILD_TYPE=Release -G Ninja && cd ./build && ninja -j$(nproc) mycc_test
    - cd $CI_PROJECT_DIR/build/bin && ./mycc_test --gtest_output="xml:xml:$CI_PROJECT_DIR/gtest_report.xml"
  artifacts:
    when: always
    reports:
      junit: $CI_PROJECT_DIR/gtest_report.xml
  needs:
    - build_gcc_10_3_ninja_debug
  cache:
    - key: "gcc_10_3_ninja_$CI_COMMIT_SHORT_SHA($CI_RUNNER_ID)"
      paths:
        - "$CI_PROJECT_DIR/build"

e2e_test_gcc_10_3_release:
  <<: *testing_default
  image: gcc:10.3
  stage: test
  tags:
    - docker
  script:
    - cd $CI_PROJECT_DIR
    - cmake . -B./build/ -DCMAKE_BUILD_TYPE=Release -G Ninja
    - cmake -B./build/ --target mycc_e2e_test
  artifacts:
    when: always
    reports:
      junit: $CI_PROJECT_DIR/build/Test/test_output/*.xunit.xml
  needs:
    - test_gcc_10_3_release
  cache:
    - key: "gcc_10_3_ninja_$CI_COMMIT_SHORT_SHA($CI_RUNNER_ID)"
      paths:
        - "$CI_PROJECT_DIR/build"

build_latex_documentation:
  <<: *documentation_default
  image: gcc:10.3
  stage: documentation
  tags:
    - docker
  script:
    - cd $CI_PROJECT_DIR
    - cmake . -B./build/ -DCMAKE_BUILD_TYPE=Release -G Ninja && cd ./build && ninja -j$(nproc) documentation